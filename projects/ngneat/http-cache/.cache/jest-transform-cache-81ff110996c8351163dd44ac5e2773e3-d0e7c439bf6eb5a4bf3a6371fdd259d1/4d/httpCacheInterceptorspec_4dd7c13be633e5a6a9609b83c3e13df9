d62f1e68b68542457b4cb5eca37b4993
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var http_1 = require("@angular/common/http");
var testing_1 = require("@angular/core/testing");
var rxjs_1 = require("rxjs");
var operators_1 = require("rxjs/operators");
var httpCacheInterceptor_1 = require("../httpCacheInterceptor");
var mocks_spec_1 = require("./mocks.spec");
describe('HttpCacheInterceptor', function () {
    var httpCacheInterceptor;
    var handler;
    var request = function (params, method, url) {
        if (method === void 0) { method = 'GET'; }
        if (url === void 0) { url = 'api/mock'; }
        return mocks_spec_1.httpRequest(method, { params: new http_1.HttpParams({ fromObject: params }) }, url);
    };
    var httpHandler = function (response) {
        if (response === void 0) { response = {}; }
        return ({
            handle: jest.fn(function () { return rxjs_1.timer(mocks_spec_1.frame).pipe(operators_1.mapTo(new http_1.HttpResponse({ body: response }))); })
        });
    };
    var call = function (req, times, delay) {
        if (times === void 0) { times = 2; }
        if (delay === void 0) { delay = mocks_spec_1.frame; }
        for (var i = 0; i < times; i++) {
            httpCacheInterceptor.intercept(req, handler).subscribe();
            testing_1.tick(delay);
        }
    };
    beforeEach(function () {
        handler = httpHandler();
        httpCacheInterceptor = new httpCacheInterceptor_1.HttpCacheInterceptor(mocks_spec_1.httpCacheManager(), mocks_spec_1.keySerializer());
        expect.hasAssertions();
    });
    it('should cache a request', testing_1.fakeAsync(function () {
        call(request({ cache$: true }));
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should not cache when cache$ is falsy', testing_1.fakeAsync(function () {
        call(request({ cache$: false }));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should not cache request of type POST', testing_1.fakeAsync(function () {
        call(request({}, 'POST'));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should cache request of type POST when cache$ is implicitly true', testing_1.fakeAsync(function () {
        call(request({ cache$: true }, 'POST'));
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should not cache the request by default on explicit strategy', testing_1.fakeAsync(function () {
        call(request({}));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should cache the request by default on implicit strategy', testing_1.fakeAsync(function () {
        httpCacheInterceptor = new httpCacheInterceptor_1.HttpCacheInterceptor(mocks_spec_1.httpCacheManager(tslib_1.__assign({}, mocks_spec_1.config, { strategy: 'implicit' })), mocks_spec_1.keySerializer());
        call(request({}));
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should not cache the request on implicit strategy and cache$ if falsy', testing_1.fakeAsync(function () {
        httpCacheInterceptor = new httpCacheInterceptor_1.HttpCacheInterceptor(mocks_spec_1.httpCacheManager(tslib_1.__assign({}, mocks_spec_1.config, { strategy: 'implicit' })), mocks_spec_1.keySerializer());
        call(request({ cache$: false }));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should return a cached request', testing_1.fakeAsync(function () {
        var cacheSpy = spyOn(httpCacheInterceptor.cacheFacade, 'get');
        call(request({ cache$: true, paramA: true }));
        expect(cacheSpy).toHaveBeenCalledTimes(1);
    }));
    it('should return a queued request', testing_1.fakeAsync(function () {
        var cacheSpy = spyOn(httpCacheInterceptor.cacheFacade.queue, 'get').and.callThrough();
        call(request({ cache$: true }), 2, 0);
        expect(cacheSpy).toHaveBeenCalledTimes(1);
        testing_1.tick(mocks_spec_1.frame);
    }));
    it('should refetch after ttl has passed', testing_1.fakeAsync(function () {
        call(request({ cache$: true }), 2, mocks_spec_1.ttl + mocks_spec_1.frame);
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should not cache a request of same url and different params', testing_1.fakeAsync(function () {
        call(request({ cache$: true, paramA: true }), 1);
        call(request({ cache$: true, paramA: false }), 1);
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should cache a request of same url and same params', testing_1.fakeAsync(function () {
        call(request({ cache$: true, paramA: true }), 2);
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should cache a request of same url and same params in queue ', testing_1.fakeAsync(function () {
        call(request({ cache$: true, paramA: true }), 2, 0);
        expect(handler.handle).toHaveBeenCalledTimes(1);
        testing_1.tick(mocks_spec_1.frame);
    }));
    it('should fetch twice for different url', testing_1.fakeAsync(function () {
        call(request({ cache$: true }, 'GET', 'url1'), 1);
        call(request({ cache$: true }, 'GET', 'url2'), 1);
        testing_1.tick(mocks_spec_1.frame);
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should add a request to cacheBucket', testing_1.fakeAsync(function () {
        var bucket = mocks_spec_1.cacheBucket();
        spyOn(bucket, 'add');
        call(request({ cache$: true, bucket$: bucket, key$: 'foo' }), 1);
        expect(bucket.add).toHaveBeenCalledWith('foo');
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxJdGF5XFxwcm9qZWN0c1xcb3BlbnNvdXJjZXNcXGh0dHAtY2FjaGVcXHByb2plY3RzXFxuZ25lYXRcXGh0dHAtY2FjaGVcXHNyY1xcbGliXFx0ZXN0XFxodHRwQ2FjaGVJbnRlcmNlcHRvci5zcGVjLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUEyRTtBQUMzRSxpREFBc0Q7QUFDdEQsNkJBQTJCO0FBQzNCLDRDQUFxQztBQUNyQyxnRUFBNkQ7QUFDN0QsMkNBQTJHO0FBRTNHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRTtJQUMvQixJQUFJLG9CQUEwQyxDQUFDO0lBQy9DLElBQUksT0FBb0IsQ0FBQztJQUN6QixJQUFJLE9BQU8sR0FBRyxVQUFDLE1BQU0sRUFBRSxNQUFjLEVBQUUsR0FBZ0I7UUFBaEMsdUJBQUEsRUFBQSxjQUFjO1FBQUUsb0JBQUEsRUFBQSxnQkFBZ0I7UUFBSyxPQUFBLHdCQUFXLENBQ3JFLE1BQU0sRUFDTixFQUFDLE1BQU0sRUFBRSxJQUFJLGlCQUFVLENBQUMsRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDLENBQUMsRUFBQyxFQUM5QyxHQUFHLENBQ0o7SUFKMkQsQ0FJM0QsQ0FBQztJQUNGLElBQU0sV0FBVyxHQUFHLFVBQUMsUUFBYTtRQUFiLHlCQUFBLEVBQUEsYUFBYTtRQUFrQixPQUFBLENBQUM7WUFDbkQsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsY0FBTSxPQUFBLFlBQUssQ0FBQyxrQkFBSyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFLLENBQUMsSUFBSSxtQkFBWSxDQUFDLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUMsQ0FBQyxFQUE1RCxDQUE0RCxDQUFDO1NBQ3BGLENBQUM7SUFGa0QsQ0FFbEQsQ0FBQztJQUNILElBQU0sSUFBSSxHQUFHLFVBQUMsR0FBRyxFQUFFLEtBQVMsRUFBRSxLQUFhO1FBQXhCLHNCQUFBLEVBQUEsU0FBUztRQUFFLHNCQUFBLEVBQUEsUUFBUSxrQkFBSztRQUN6QyxLQUFJ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LEVBQUUsbUJBQVMsQ0FBQztRQUNuRCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNoRCxjQUFJLENBQUMsa0JBQUssQ0FBQyxDQUFDO1FBQ1osTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRUosRUFBRSxDQUFDLHFDQUFxQyxFQUFFLG1CQUFTLENBQUM7UUFDbEQsSUFBTSxNQUFNLEdBQUcsd0JBQVcsRUFBRSxDQUFDO1FBQzdCLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvRCxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pELENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFTixDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXEl0YXlcXHByb2plY3RzXFxvcGVuc291cmNlc1xcaHR0cC1jYWNoZVxccHJvamVjdHNcXG5nbmVhdFxcaHR0cC1jYWNoZVxcc3JjXFxsaWJcXHRlc3RcXGh0dHBDYWNoZUludGVyY2VwdG9yLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtIdHRwSGFuZGxlciwgSHR0cFJlc3BvbnNlLCBIdHRwUGFyYW1zfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge2Zha2VBc3luYywgdGlja30gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7dGltZXJ9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXBUb30gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtIdHRwQ2FjaGVJbnRlcmNlcHRvcn0gZnJvbSAnLi4vaHR0cENhY2hlSW50ZXJjZXB0b3InO1xuaW1wb3J0IHtodHRwQ2FjaGVNYW5hZ2VyLCBrZXlTZXJpYWxpemVyLCBodHRwUmVxdWVzdCwgY29uZmlnLCBmcmFtZSwgdHRsLCBjYWNoZUJ1Y2tldH0gZnJvbSAnLi9tb2Nrcy5zcGVjJztcblxuZGVzY3JpYmUoJ0h0dHBDYWNoZUludGVyY2VwdG9yJywgKCkgPT4ge1xuICBsZXQgaHR0cENhY2hlSW50ZXJjZXB0b3I6IEh0dHBDYWNoZUludGVyY2VwdG9yO1xuICBsZXQgaGFuZGxlcjogSHR0cEhhbmRsZXI7XG4gIGxldCByZXF1ZXN0ID0gKHBhcmFtcywgbWV0aG9kID0gJ0dFVCcsIHVybCA9ICdhcGkvbW9jaycpID0+IGh0dHBSZXF1ZXN0KFxuICAgIG1ldGhvZCxcbiAgICB7cGFyYW1zOiBuZXcgSHR0cFBhcmFtcyh7ZnJvbU9iamVjdDogcGFyYW1zfSl9LFxuICAgIHVybFxuICApO1xuICBjb25zdCBodHRwSGFuZGxlciA9IChyZXNwb25zZSA9IHt9KTogSHR0cEhhbmRsZXIgPT4gKHtcbiAgICBoYW5kbGU6IGplc3QuZm4oKCkgPT4gdGltZXIoZnJhbWUpLnBpcGUobWFwVG8obmV3IEh0dHBSZXNwb25zZSh7Ym9keTogcmVzcG9uc2V9KSkpKVxuICB9KTtcbiAgY29uc3QgY2FsbCA9IChyZXEsIHRpbWVzID0gMiwgZGVsYXkgPSBmcmFtZSkgPT4ge1xuICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aW1lczsgaSsrKSB7XG4gICAgICBodHRwQ2FjaGVJbnRlcmNlcHRvci5pbnRlcmNlcHQocmVxLCBoYW5kbGVyKS5zdWJzY3JpYmUoKTtcbiAgICAgIHRpY2soZGVsYXkpO1xuICAgIH1cbiAgfTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBoYW5kbGVyID0gaHR0cEhhbmRsZXIoKTtcbiAgICBodHRwQ2FjaGVJbnRlcmNlcHRvciA9IG5ldyBIdHRwQ2FjaGVJbnRlcmNlcHRvcihodHRwQ2FjaGVNYW5hZ2VyKCksIGtleVNlcmlhbGl6ZXIoKSk7XG4gICAgZXhwZWN0Lmhhc0Fzc2VydGlvbnMoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjYWNoZSBhIHJlcXVlc3QnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlfSkpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBub3QgY2FjaGUgd2hlbiBjYWNoZSQgaXMgZmFsc3knLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiBmYWxzZX0pKTtcbiAgICBleHBlY3QoaGFuZGxlci5oYW5kbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgbm90IGNhY2hlIHJlcXVlc3Qgb2YgdHlwZSBQT1NUJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe30sICdQT1NUJykpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBjYWNoZSByZXF1ZXN0IG9mIHR5cGUgUE9TVCB3aGVuIGNhY2hlJCBpcyBpbXBsaWNpdGx5IHRydWUnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlfSwgJ1BPU1QnKSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIG5vdCBjYWNoZSB0aGUgcmVxdWVzdCBieSBkZWZhdWx0IG9uIGV4cGxpY2l0IHN0cmF0ZWd5JywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe30pKTtcbiAgICBleHBlY3QoaGFuZGxlci5oYW5kbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgY2FjaGUgdGhlIHJlcXVlc3QgYnkgZGVmYXVsdCBvbiBpbXBsaWNpdCBzdHJhdGVneScsIGZha2VBc3luYygoKSA9PiB7XG4gICAgaHR0cENhY2hlSW50ZXJjZXB0b3IgPSBuZXcgSHR0cENhY2hlSW50ZXJjZXB0b3IoXG4gICAgICBodHRwQ2FjaGVNYW5hZ2VyKHsuLi5jb25maWcsIHN0cmF0ZWd5OiAnaW1wbGljaXQnfSksXG4gICAgICBrZXlTZXJpYWxpemVyKClcbiAgICApO1xuICAgIGNhbGwocmVxdWVzdCh7fSkpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBub3QgY2FjaGUgdGhlIHJlcXVlc3Qgb24gaW1wbGljaXQgc3RyYXRlZ3kgYW5kIGNhY2hlJCBpZiBmYWxzeScsIGZha2VBc3luYygoKSA9PiB7XG4gICAgaHR0cENhY2hlSW50ZXJjZXB0b3IgPSBuZXcgSHR0cENhY2hlSW50ZXJjZXB0b3IoXG4gICAgICAgIGh0dHBDYWNoZU1hbmFnZXIoey4uLmNvbmZpZywgc3RyYXRlZ3k6ICdpbXBsaWNpdCd9KSxcbiAgICAgICAga2V5U2VyaWFsaXplcigpXG4gICAgKTtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogZmFsc2V9KSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBhIGNhY2hlZCByZXF1ZXN0JywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjb25zdCBjYWNoZVNweSA9IHNweU9uKChodHRwQ2FjaGVJbnRlcmNlcHRvciBhcyBhbnkpLmNhY2hlRmFjYWRlLCAnZ2V0Jyk7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWUsIHBhcmFtQTogdHJ1ZX0pKTtcbiAgICBleHBlY3QoY2FjaGVTcHkpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIGEgcXVldWVkIHJlcXVlc3QnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNvbnN0IGNhY2hlU3B5ID0gc3B5T24oKGh0dHBDYWNoZUludGVyY2VwdG9yIGFzIGFueSkuY2FjaGVGYWNhZGUucXVldWUsICdnZXQnKS5hbmQuY2FsbFRocm91Z2goKTtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZX0pLCAyLCAwKTtcbiAgICBleHBlY3QoY2FjaGVTcHkpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICB0aWNrKGZyYW1lKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgcmVmZXRjaCBhZnRlciB0dGwgaGFzIHBhc3NlZCcsIGZha2VBc3luYygoKSA9PiB7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWV9KSwgMiwgdHRsICsgZnJhbWUpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBub3QgY2FjaGUgYSByZXF1ZXN0IG9mIHNhbWUgdXJsIGFuZCBkaWZmZXJlbnQgcGFyYW1zJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZSwgcGFyYW1BOiB0cnVlfSksIDEpO1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlLCBwYXJhbUE6IGZhbHNlfSksIDEpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBjYWNoZSBhIHJlcXVlc3Qgb2Ygc2FtZSB1cmwgYW5kIHNhbWUgcGFyYW1zJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZSwgcGFyYW1BOiB0cnVlfSksIDIpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBjYWNoZSBhIHJlcXVlc3Qgb2Ygc2FtZSB1cmwgYW5kIHNhbWUgcGFyYW1zIGluIHF1ZXVlICcsIGZha2VBc3luYygoKSA9PiB7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWUsIHBhcmFtQTogdHJ1ZX0pLCAyLCAwKTtcbiAgICBleHBlY3QoaGFuZGxlci5oYW5kbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICB0aWNrKGZyYW1lKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgZmV0Y2ggdHdpY2UgZm9yIGRpZmZlcmVudCB1cmwnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlfSwgJ0dFVCcsICd1cmwxJyksIDEpO1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlfSwgJ0dFVCcsICd1cmwyJyksIDEpO1xuICAgIHRpY2soZnJhbWUpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBhZGQgYSByZXF1ZXN0IHRvIGNhY2hlQnVja2V0JywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjb25zdCBidWNrZXQgPSBjYWNoZUJ1Y2tldCgpO1xuICAgIHNweU9uKGJ1Y2tldCwgJ2FkZCcpO1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlLCBidWNrZXQkOiBidWNrZXQsIGtleSQ6ICdmb28nfSksIDEpO1xuICAgIGV4cGVjdChidWNrZXQuYWRkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnZm9vJyk7XG4gIH0pKTtcblxufSk7XG4iXSwidmVyc2lvbiI6M30=