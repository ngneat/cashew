{"file":"C:\\Users\\Itay\\projects\\opensources\\http-cache\\projects\\ngneat\\http-cache\\src\\lib\\httpCacheInterceptor.ts","mappings":";;;AAAA,sCAA2C;AAC3C,6CAA0G;AAC1G,6BAAsC;AACtC,4CAA4C;AAE5C,uEAA8D;AAC9D,2DAA0D;AAC1D,iDAAgD;AAIhD;IACE,8BAAoB,WAA6B,EAAU,aAA4B;QAAnE,gBAAW,GAAX,WAAW,CAAkB;QAAU,kBAAa,GAAb,aAAa,CAAe;IAAG,CAAC;IAE3F,wCAAS,GAAT,UAAU,OAAyB,EAAE,IAAiB;QAAtD,iBAuCC;QAtCC,IAAM,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAC3D,IAAM,KAAK,GAAG,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAC3C,IAAM,GAAG,GAAG,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACvC,IAAM,SAAS,GAAG,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QAC7C,IAAM,MAAM,GAAQ,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QAElD,IAAM,KAAK,GAAG,uCAAkB,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC;QACrD,IAAM,GAAG,GAAG,IAAI,CAAC,aAAa,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QAEhD,IAAI,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,WAAW,EAAE,KAAK,CAAC,EAAE;YACrD,MAAM,IAAK,MAAsB,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAC3C,2DAA2D;YAC3D,aAAa;YACb,IAAI,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE;gBACnC,aAAa;gBACb,OAAO,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;aACxC;YAED,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;gBAClC,OAAO,SAAE,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC;aACtC;YACD,8DAA8D;YAC9D,IAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,IAAI,CACpC,eAAG,CAAC,UAAA,KAAK;gBACP,IAAI,KAAK,YAAY,mBAAY,EAAE;oBACjC,KAAI,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,EAAE,KAAK,EAAE,CAAC,GAAG,CAAC,CAAC;iBACzC;YACH,CAAC,CAAC,EACF,iBAAK,EAAE,CACR,CAAC;YAEF,aAAa;YACb,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;YAExC,OAAO,MAAM,CAAC;SACf;QAED,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IAC5B,CAAC;IA1CU,oBAAoB;QADhC,iBAAU,EAAE;iDAEsB,2CAAgB,EAAyB,6BAAa;OAD5E,oBAAoB,CA2ChC;IAAD,2BAAC;CAAA,AA3CD,IA2CC;AA3CY,oDAAoB","names":[],"sources":["C:\\Users\\Itay\\projects\\opensources\\http-cache\\projects\\ngneat\\http-cache\\src\\lib\\httpCacheInterceptor.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpEvent, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse } from '@angular/common/http';\nimport { Observable, of } from 'rxjs';\nimport { share, tap } from 'rxjs/operators';\n\nimport { HttpCacheManager } from './httpCacheManager.service';\nimport { cloneWithoutParams } from './cloneWithoutParams';\nimport { KeySerializer } from './keySerializer';\nimport { CacheBucket } from './cacheBucket';\n\n@Injectable()\nexport class HttpCacheInterceptor implements HttpInterceptor {\n  constructor(private cacheFacade: HttpCacheManager, private keySerializer: KeySerializer) {}\n\n  intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n    const canActivate = this.cacheFacade._canActivate(request);\n    const cache = request.params.get('cache$');\n    const ttl = request.params.get('ttl$');\n    const customKey = request.params.get('key$');\n    const bucket: any = request.params.get('bucket$');\n\n    const clone = cloneWithoutParams(request, customKey);\n    const key = this.keySerializer.serialize(clone);\n\n    if (this.cacheFacade._isCacheable(canActivate, cache)) {\n      bucket && (bucket as CacheBucket).add(key);\n      // TODO: wouldn't _queue be better instead of ts-ignore it.\n      // @ts-ignore\n      if (this.cacheFacade.queue.has(key)) {\n        // @ts-ignore\n        return this.cacheFacade.queue.get(key);\n      }\n\n      if (this.cacheFacade.validate(key)) {\n        return of(this.cacheFacade.get(key));\n      }\n      //TODO: I would split that to function (for readability sake).\n      const shared = next.handle(clone).pipe(\n        tap(event => {\n          if (event instanceof HttpResponse) {\n            this.cacheFacade._set(key, event, +ttl);\n          }\n        }),\n        share()\n      );\n\n      // @ts-ignore\n      this.cacheFacade.queue.set(key, shared);\n\n      return shared;\n    }\n\n    return next.handle(clone);\n  }\n}\n"],"version":3}