"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var http_1 = require("@angular/common/http");
var testing_1 = require("@angular/core/testing");
var rxjs_1 = require("rxjs");
var operators_1 = require("rxjs/operators");
var httpCacheInterceptor_1 = require("../httpCacheInterceptor");
var mocks_spec_1 = require("./mocks.spec");
describe('HttpCacheInterceptor', function () {
    var httpCacheInterceptor;
    var handler;
    var request = function (params, method, url) {
        if (method === void 0) { method = 'GET'; }
        if (url === void 0) { url = 'api/mock'; }
        return mocks_spec_1.httpRequest(method, { params: new http_1.HttpParams({ fromObject: params }) }, url);
    };
    var httpHandler = function (response) {
        if (response === void 0) { response = {}; }
        return ({
            handle: jest.fn(function () { return rxjs_1.timer(mocks_spec_1.frame).pipe(operators_1.mapTo(new http_1.HttpResponse({ body: response }))); })
        });
    };
    var call = function (req, times, delay) {
        if (times === void 0) { times = 2; }
        if (delay === void 0) { delay = mocks_spec_1.frame; }
        for (var i = 0; i < times; i++) {
            httpCacheInterceptor.intercept(req, handler).subscribe();
            testing_1.tick(delay);
        }
    };
    beforeEach(function () {
        handler = httpHandler();
        httpCacheInterceptor = new httpCacheInterceptor_1.HttpCacheInterceptor(mocks_spec_1.httpCacheManager(), mocks_spec_1.keySerializer());
        expect.hasAssertions();
    });
    it('should cache a request', testing_1.fakeAsync(function () {
        call(request({ cache$: true }));
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should not cache when cache$ is falsy', testing_1.fakeAsync(function () {
        call(request({ cache$: false }));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should not cache request of type POST', testing_1.fakeAsync(function () {
        call(request({}, 'POST'));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should cache request of type POST when cache$ is implicitly true', testing_1.fakeAsync(function () {
        call(request({ cache$: true }, 'POST'));
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should not cache the request by default on explicit strategy', testing_1.fakeAsync(function () {
        call(request({}));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should cache the request by default on implicit strategy', testing_1.fakeAsync(function () {
        httpCacheInterceptor = new httpCacheInterceptor_1.HttpCacheInterceptor(mocks_spec_1.httpCacheManager(tslib_1.__assign({}, mocks_spec_1.config, { strategy: 'implicit' })), mocks_spec_1.keySerializer());
        call(request({}));
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should not cache the request on implicit strategy and cache$ if falsy', testing_1.fakeAsync(function () {
        httpCacheInterceptor = new httpCacheInterceptor_1.HttpCacheInterceptor(mocks_spec_1.httpCacheManager(tslib_1.__assign({}, mocks_spec_1.config, { strategy: 'implicit' })), mocks_spec_1.keySerializer());
        call(request({ cache$: false }));
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should return a cached request', testing_1.fakeAsync(function () {
        var cacheSpy = spyOn(httpCacheInterceptor.httpCacheManager, 'get');
        call(request({ cache$: true, paramA: true }));
        expect(cacheSpy).toHaveBeenCalledTimes(1);
    }));
    it('should return a queued request', testing_1.fakeAsync(function () {
        var cacheSpy = spyOn(httpCacheInterceptor.httpCacheManager.queue, 'get').and.callThrough();
        call(request({ cache$: true }), 2, 0);
        expect(cacheSpy).toHaveBeenCalledTimes(1);
        testing_1.tick(mocks_spec_1.frame);
    }));
    it('should refetch after ttl has passed', testing_1.fakeAsync(function () {
        call(request({ cache$: true }), 2, mocks_spec_1.ttl + mocks_spec_1.frame);
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should not cache a request of same url and different params', testing_1.fakeAsync(function () {
        call(request({ cache$: true, paramA: true }), 1);
        call(request({ cache$: true, paramA: false }), 1);
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should cache a request of same url and same params', testing_1.fakeAsync(function () {
        call(request({ cache$: true, paramA: true }), 2);
        expect(handler.handle).toHaveBeenCalledTimes(1);
    }));
    it('should cache a request of same url and same params in queue ', testing_1.fakeAsync(function () {
        call(request({ cache$: true, paramA: true }), 2, 0);
        expect(handler.handle).toHaveBeenCalledTimes(1);
        testing_1.tick(mocks_spec_1.frame);
    }));
    it('should fetch twice for different url', testing_1.fakeAsync(function () {
        call(request({ cache$: true }, 'GET', 'url1'), 1);
        call(request({ cache$: true }, 'GET', 'url2'), 1);
        testing_1.tick(mocks_spec_1.frame);
        expect(handler.handle).toHaveBeenCalledTimes(2);
    }));
    it('should add a request to cacheBucket', testing_1.fakeAsync(function () {
        var bucket = mocks_spec_1.cacheBucket();
        spyOn(bucket, 'add');
        call(request({ cache$: true, bucket$: bucket, key$: 'foo' }), 1);
        expect(bucket.add).toHaveBeenCalledWith('foo');
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxJdGF5XFxwcm9qZWN0c1xcb3BlbnNvdXJjZXNcXGh0dHAtY2FjaGVcXHByb2plY3RzXFxuZ25lYXRcXGh0dHAtY2FjaGVcXHNyY1xcbGliXFx0ZXN0XFxodHRwQ2FjaGVJbnRlcmNlcHRvci5zcGVjLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUEyRTtBQUMzRSxpREFBc0Q7QUFDdEQsNkJBQTJCO0FBQzNCLDRDQUFxQztBQUNyQyxnRUFBNkQ7QUFDN0QsMkNBQTJHO0FBRTNHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRTtJQUMvQixJQUFJLG9CQUEwQyxDQUFDO0lBQy9DLElBQUksT0FBb0IsQ0FBQztJQUN6QixJQUFJLE9BQU8sR0FBRyxVQUFDLE1BQU0sRUFBRSxNQUFjLEVBQUUsR0FBZ0I7UUFBaEMsdUJBQUEsRUFBQSxjQUFjO1FBQUUsb0JBQUEsRUFBQSxnQkFBZ0I7UUFBSyxPQUFBLHdCQUFXLENBQ3JFLE1BQU0sRUFDTixFQUFDLE1BQU0sRUFBRSxJQUFJLGlCQUFVLENBQUMsRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDLENBQUMsRUFBQyxFQUM5QyxHQUFHLENBQ0o7SUFKMkQsQ0FJM0QsQ0FBQztJQUNGLElBQU0sV0FBVyxHQUFHLFVBQUMsUUFBYTtRQUFiLHlCQUFBLEVBQUEsYUFBYTtRQUFrQixPQUFBLENBQUM7WUFDbkQsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsY0FBTSxPQUFBLFlBQUssQ0FBQyxrQkFBSyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFLLENBQUMsSUFBSSxtQkFBWSxDQUFDLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUMsQ0FBQyxFQUE1RCxDQUE0RCxDQUFDO1NBQ3BGLENBQUM7SUFGa0QsQ0FFbEQsQ0FBQztJQUNILElBQU0sSUFBSSxHQUFHLFVBQUMsR0FBRyxFQUFFLEtBQVMsRUFBRSxLQUFhO1FBQXhCLHNCQUFBLEVBQUEsU0FBUztRQUFFLHNCQUFBLEVBQUEsUUFBUSxrQkFBSztRQUN6QyxLQUFJ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QUFzQyxFQUFFLG1CQUFTLENBQUM7UUFDbkQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDaEQsY0FBSSxDQUFDLGtCQUFLLENBQUMsQ0FBQztRQUNaLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVKLEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSxtQkFBUyxDQUFDO1FBQ2xELElBQU0sTUFBTSxHQUFHLHdCQUFXLEVBQUUsQ0FBQztRQUM3QixLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDL0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRU4sQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxJdGF5XFxwcm9qZWN0c1xcb3BlbnNvdXJjZXNcXGh0dHAtY2FjaGVcXHByb2plY3RzXFxuZ25lYXRcXGh0dHAtY2FjaGVcXHNyY1xcbGliXFx0ZXN0XFxodHRwQ2FjaGVJbnRlcmNlcHRvci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SHR0cEhhbmRsZXIsIEh0dHBSZXNwb25zZSwgSHR0cFBhcmFtc30gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtmYWtlQXN5bmMsIHRpY2t9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQge3RpbWVyfSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwVG99IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7SHR0cENhY2hlSW50ZXJjZXB0b3J9IGZyb20gJy4uL2h0dHBDYWNoZUludGVyY2VwdG9yJztcbmltcG9ydCB7aHR0cENhY2hlTWFuYWdlciwga2V5U2VyaWFsaXplciwgaHR0cFJlcXVlc3QsIGNvbmZpZywgZnJhbWUsIHR0bCwgY2FjaGVCdWNrZXR9IGZyb20gJy4vbW9ja3Muc3BlYyc7XG5cbmRlc2NyaWJlKCdIdHRwQ2FjaGVJbnRlcmNlcHRvcicsICgpID0+IHtcbiAgbGV0IGh0dHBDYWNoZUludGVyY2VwdG9yOiBIdHRwQ2FjaGVJbnRlcmNlcHRvcjtcbiAgbGV0IGhhbmRsZXI6IEh0dHBIYW5kbGVyO1xuICBsZXQgcmVxdWVzdCA9IChwYXJhbXMsIG1ldGhvZCA9ICdHRVQnLCB1cmwgPSAnYXBpL21vY2snKSA9PiBodHRwUmVxdWVzdChcbiAgICBtZXRob2QsXG4gICAge3BhcmFtczogbmV3IEh0dHBQYXJhbXMoe2Zyb21PYmplY3Q6IHBhcmFtc30pfSxcbiAgICB1cmxcbiAgKTtcbiAgY29uc3QgaHR0cEhhbmRsZXIgPSAocmVzcG9uc2UgPSB7fSk6IEh0dHBIYW5kbGVyID0+ICh7XG4gICAgaGFuZGxlOiBqZXN0LmZuKCgpID0+IHRpbWVyKGZyYW1lKS5waXBlKG1hcFRvKG5ldyBIdHRwUmVzcG9uc2Uoe2JvZHk6IHJlc3BvbnNlfSkpKSlcbiAgfSk7XG4gIGNvbnN0IGNhbGwgPSAocmVxLCB0aW1lcyA9IDIsIGRlbGF5ID0gZnJhbWUpID0+IHtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGltZXM7IGkrKykge1xuICAgICAgaHR0cENhY2hlSW50ZXJjZXB0b3IuaW50ZXJjZXB0KHJlcSwgaGFuZGxlcikuc3Vic2NyaWJlKCk7XG4gICAgICB0aWNrKGRlbGF5KTtcbiAgICB9XG4gIH07XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgaGFuZGxlciA9IGh0dHBIYW5kbGVyKCk7XG4gICAgaHR0cENhY2hlSW50ZXJjZXB0b3IgPSBuZXcgSHR0cENhY2hlSW50ZXJjZXB0b3IoaHR0cENhY2hlTWFuYWdlcigpLCBrZXlTZXJpYWxpemVyKCkpO1xuICAgIGV4cGVjdC5oYXNBc3NlcnRpb25zKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY2FjaGUgYSByZXF1ZXN0JywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZX0pKTtcbiAgICBleHBlY3QoaGFuZGxlci5oYW5kbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgbm90IGNhY2hlIHdoZW4gY2FjaGUkIGlzIGZhbHN5JywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogZmFsc2V9KSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIG5vdCBjYWNoZSByZXF1ZXN0IG9mIHR5cGUgUE9TVCcsIGZha2VBc3luYygoKSA9PiB7XG4gICAgY2FsbChyZXF1ZXN0KHt9LCAnUE9TVCcpKTtcbiAgICBleHBlY3QoaGFuZGxlci5oYW5kbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgY2FjaGUgcmVxdWVzdCBvZiB0eXBlIFBPU1Qgd2hlbiBjYWNoZSQgaXMgaW1wbGljaXRseSB0cnVlJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZX0sICdQT1NUJykpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBub3QgY2FjaGUgdGhlIHJlcXVlc3QgYnkgZGVmYXVsdCBvbiBleHBsaWNpdCBzdHJhdGVneScsIGZha2VBc3luYygoKSA9PiB7XG4gICAgY2FsbChyZXF1ZXN0KHt9KSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIGNhY2hlIHRoZSByZXF1ZXN0IGJ5IGRlZmF1bHQgb24gaW1wbGljaXQgc3RyYXRlZ3knLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGh0dHBDYWNoZUludGVyY2VwdG9yID0gbmV3IEh0dHBDYWNoZUludGVyY2VwdG9yKFxuICAgICAgaHR0cENhY2hlTWFuYWdlcih7Li4uY29uZmlnLCBzdHJhdGVneTogJ2ltcGxpY2l0J30pLFxuICAgICAga2V5U2VyaWFsaXplcigpXG4gICAgKTtcbiAgICBjYWxsKHJlcXVlc3Qoe30pKTtcbiAgICBleHBlY3QoaGFuZGxlci5oYW5kbGUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgbm90IGNhY2hlIHRoZSByZXF1ZXN0IG9uIGltcGxpY2l0IHN0cmF0ZWd5IGFuZCBjYWNoZSQgaWYgZmFsc3knLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGh0dHBDYWNoZUludGVyY2VwdG9yID0gbmV3IEh0dHBDYWNoZUludGVyY2VwdG9yKFxuICAgICAgICBodHRwQ2FjaGVNYW5hZ2VyKHsuLi5jb25maWcsIHN0cmF0ZWd5OiAnaW1wbGljaXQnfSksXG4gICAgICAgIGtleVNlcmlhbGl6ZXIoKVxuICAgICk7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IGZhbHNlfSkpO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gYSBjYWNoZWQgcmVxdWVzdCcsIGZha2VBc3luYygoKSA9PiB7XG4gICAgY29uc3QgY2FjaGVTcHkgPSBzcHlPbigoaHR0cENhY2hlSW50ZXJjZXB0b3IgYXMgYW55KS5odHRwQ2FjaGVNYW5hZ2VyLCAnZ2V0Jyk7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWUsIHBhcmFtQTogdHJ1ZX0pKTtcbiAgICBleHBlY3QoY2FjaGVTcHkpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgfSkpO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIGEgcXVldWVkIHJlcXVlc3QnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNvbnN0IGNhY2hlU3B5ID0gc3B5T24oKGh0dHBDYWNoZUludGVyY2VwdG9yIGFzIGFueSkuaHR0cENhY2hlTWFuYWdlci5xdWV1ZSwgJ2dldCcpLmFuZC5jYWxsVGhyb3VnaCgpO1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlfSksIDIsIDApO1xuICAgIGV4cGVjdChjYWNoZVNweSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIHRpY2soZnJhbWUpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCByZWZldGNoIGFmdGVyIHR0bCBoYXMgcGFzc2VkJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZX0pLCAyLCB0dGwgKyBmcmFtZSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIG5vdCBjYWNoZSBhIHJlcXVlc3Qgb2Ygc2FtZSB1cmwgYW5kIGRpZmZlcmVudCBwYXJhbXMnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlLCBwYXJhbUE6IHRydWV9KSwgMSk7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWUsIHBhcmFtQTogZmFsc2V9KSwgMSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIGNhY2hlIGEgcmVxdWVzdCBvZiBzYW1lIHVybCBhbmQgc2FtZSBwYXJhbXMnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNhbGwocmVxdWVzdCh7Y2FjaGUkOiB0cnVlLCBwYXJhbUE6IHRydWV9KSwgMik7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIGNhY2hlIGEgcmVxdWVzdCBvZiBzYW1lIHVybCBhbmQgc2FtZSBwYXJhbXMgaW4gcXVldWUgJywgZmFrZUFzeW5jKCgpID0+IHtcbiAgICBjYWxsKHJlcXVlc3Qoe2NhY2hlJDogdHJ1ZSwgcGFyYW1BOiB0cnVlfSksIDIsIDApO1xuICAgIGV4cGVjdChoYW5kbGVyLmhhbmRsZSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIHRpY2soZnJhbWUpO1xuICB9KSk7XG5cbiAgaXQoJ3Nob3VsZCBmZXRjaCB0d2ljZSBmb3IgZGlmZmVyZW50IHVybCcsIGZha2VBc3luYygoKSA9PiB7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWV9LCAnR0VUJywgJ3VybDEnKSwgMSk7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWV9LCAnR0VUJywgJ3VybDInKSwgMSk7XG4gICAgdGljayhmcmFtZSk7XG4gICAgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIH0pKTtcblxuICBpdCgnc2hvdWxkIGFkZCBhIHJlcXVlc3QgdG8gY2FjaGVCdWNrZXQnLCBmYWtlQXN5bmMoKCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldCA9IGNhY2hlQnVja2V0KCk7XG4gICAgc3B5T24oYnVja2V0LCAnYWRkJyk7XG4gICAgY2FsbChyZXF1ZXN0KHtjYWNoZSQ6IHRydWUsIGJ1Y2tldCQ6IGJ1Y2tldCwga2V5JDogJ2Zvbyd9KSwgMSk7XG4gICAgZXhwZWN0KGJ1Y2tldC5hZGQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdmb28nKTtcbiAgfSkpO1xuXG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==